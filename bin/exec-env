#!/usr/bin/env bash

set -euo pipefail

# shellcheck source-path=.
source "$MISE_PLUGIN_PATH/bin/utils.sh"

setup_virtualenv() {
  VIRTUAL_ENV="$(poetry_venv)"
  if [[ -z "$VIRTUAL_ENV" ]]; then
    return
  fi

  if [[ ! -d $VIRTUAL_ENV ]]; then
    echoerr "rtx-poetry: No virtualenv exists. Executing \`poetry install\` to create one."
    "$(poetry_bin)" install
    VIRTUAL_ENV="$("$(poetry_bin)" env info --path)"
  fi

  POETRY_ACTIVE=1
  MISE_ADD_PATH="$VIRTUAL_ENV/bin"
  export VIRTUAL_ENV POETRY_ACTIVE MISE_ADD_PATH
}

setup_virtualenv
